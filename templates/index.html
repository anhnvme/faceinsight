{% extends "base.html" %}

{% block content %}
<!-- Status Cards -->
<div class="status-cards">
    <div class="status-card">
        <div class="status-card-icon blue">ü§ñ</div>
        <div class="status-card-content">
            <div class="status-card-title">Recognition Model</div>
            <div class="status-card-value">
                {% if current_model == 'buffalo_s' %}Buffalo S
                {% elif current_model == 'buffalo_l' %}Buffalo L
                {% elif current_model == 'antelopev2' %}Antelope v2
                {% else %}{{ current_model }}{% endif %}
            </div>
            <div class="status-card-badge badge-success">Active</div>
        </div>
    </div>
    
    <div class="status-card{% if not mqtt_configured %} status-card-warning{% endif %}">
        <div class="status-card-icon {% if mqtt_configured %}green{% else %}orange{% endif %}">üì°</div>
        <div class="status-card-content">
            <div class="status-card-title">MQTT Connection</div>
            <div class="status-card-value">
                {% if mqtt_configured %}
                {{ mqtt_host }}
                {% else %}
                Not configured
                {% endif %}
            </div>
            <div class="status-card-badge {% if mqtt_configured %}badge-success{% else %}badge-warning{% endif %}">
                {% if mqtt_configured %}
                Active
                {% else %}
                ‚ö†Ô∏è Ch∆∞a c·∫•u h√¨nh
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="status-card">
        <div class="status-card-icon teal">üë•</div>
        <div class="status-card-content">
            <div class="status-card-title">Face Collection</div>
            <div class="status-card-value">{{ persons|length }} ng∆∞·ªùi</div>
            <div class="status-card-badge badge-info">{{ persons|sum(attribute='image_count') }} faces</div>
        </div>
    </div>
    
    <div class="status-card status-card-clickable" onclick="refreshStorage()" style="cursor: pointer;" title="Click ƒë·ªÉ c·∫≠p nh·∫≠t dung l∆∞·ª£ng">
        <div class="status-card-icon purple">üíæ</div>
        <div class="status-card-content">
            <div class="status-card-title">Storage Usage</div>
            <div class="status-card-value" id="storageTotal">{{ storage_total or '0 MB' }}</div>
            <div class="status-card-badge badge-info" id="storageDetails">
                Models: <span id="storageModels">{{ storage_models or '0 MB' }}</span> | 
                Data: <span id="storageData">{{ storage_data or '0 MB' }}</span>
            </div>
        </div>
    </div>
</div>

<div class="page-header">
    <h2>üë• Qu·∫£n L√Ω Khu√¥n M·∫∑t</h2>
    <button onclick="showAddPersonModal()" class="btn btn-primary">‚ûï Th√™m Ng∆∞·ªùi M·ªõi</button>
</div>

<div class="persons-grid">
    {% for person in persons %}
    <div class="person-card" id="person-{{ person.id }}">
        <div class="person-header">
            <div class="person-info">
                <h3>
                    {% if person.nickname %} {{ person.nickname }} {%else %} {{ person.name }} {% endif %}
                    <span id="upload-status-{{ person.id }}" class="upload-status" style="margin-left: 8px; font-size: 1.2rem;"></span>
                </h3>
                {% if person.nickname %}
                <p class="nickname">{{ person.name }}</p>
                {% endif %}
            </div>
            <span class="image-count">{{ person.image_count }}/{{ max_images }} ·∫£nh - {{ person.embed_count }} embed</span>
        </div>
        <div class="person-images">
            {% for img in person.images %}
            <div class="image-item">
                <img src="{{ url_for('static', filename=img.image_path.replace('static/', '')) }}" 
                     alt="{{ person.name }}"
                     onclick="showImagePreview('{{ img.original_image_path or img.image_path }}', '{{ person.nickname or person.name }}')"
                     style="cursor: pointer;"
                     title="Click ƒë·ªÉ xem ·∫£nh g·ªëc">
                <button onclick="deleteImage({{ person.id }}, {{ img.id }})" class="btn-delete">√ó</button>
            </div>
            {% endfor %}
        </div>
        <div class="person-actions">
            {% if person.image_count < max_images %}
            <button onclick="addImage({{ person.id }})" class="btn btn-sm">Th√™m ·∫¢nh</button>
            {% endif %}
            <button onclick="editPerson({{ person.id }}, '{{ person.name }}', '{{ person.nickname or '' }}')" class="btn btn-sm">S·ª≠a</button>
            <button onclick="deletePerson({{ person.id }})" class="btn btn-sm btn-danger">X√≥a</button>
        </div>
    </div>
    {% endfor %}
</div>

<div id="addPersonModal" class="modal d-none">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3>Th√™m Ng∆∞·ªùi M·ªõi</h3>
        <form id="addPersonForm" enctype="multipart/form-data">
            <div class="form-group">
                <label>Nickname (*) - T√™n hi·ªÉn th·ªã</label>
                <input type="text" id="nicknameInput" name="nickname" required placeholder="VD: Vi·ªát Anh">
            </div>
            <div class="form-group">
                <label>T√™n (*) - T·ª± ƒë·ªông t·∫°o (c√≥ th·ªÉ ch·ªânh s·ª≠a)</label>
                <input type="text" id="nameInput" name="name" required placeholder="S·∫Ω t·ª± ƒë·ªông ƒëi·ªÅn...">
                <small id="namePreview" style="color: #667eea; font-weight: 600; display: block; margin-top: 0.25rem;">Nh·∫≠p Nickname ƒë·ªÉ t·ª± ƒë·ªông t·∫°o t√™n</small>
            </div>
            <div class="form-group">
                <label>·∫¢nh (T·ªëi ƒëa {{ max_images }})</label>
                <input type="file" name="images" multiple accept="image/*">
            </div>
            <button type="submit" class="btn btn-primary">Th√™m</button>
        </form>
    </div>
</div>

<div id="editPersonModal" class="modal d-none">
    <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h3>S·ª≠a Th√¥ng Tin</h3>
        <form id="editPersonForm">
            <input type="hidden" id="editPersonId">
            <div class="form-group">
                <label>T√™n</label>
                <input type="text" id="editName" name="name" disabled class="input-disabled">
                <small class="text-small">T√™n kh√¥ng th·ªÉ thay ƒë·ªïi sau khi t·∫°o</small>
            </div>
            <div class="form-group">
                <label>Nickname (T√™n hi·ªÉn th·ªã)</label>
                <input type="text" id="editNickname" name="nickname">
            </div>
            <button type="submit" class="btn btn-primary">L∆∞u</button>
        </form>
    </div>
</div>

<input type="file" id="imageInput" class="d-none" accept="image/*" multiple>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/index.js') }}"></script>
{% endblock %}

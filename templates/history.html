{% extends "base.html" %}

{% block content %}
<div class="history-list">
    {% for record in history %}
    <div class="history-item" id="history-{{ record.id }}">
        <div class="history-thumbnail" onclick="showImagePreview('{{ url_for('static', filename=record.image_path.replace('static/', '')) }}', '{{ record.nickname or record.person_name }}')">
            {% if record.thumbnail_path %}
            <img id="history-img-{{ record.id }}" src="{{ url_for('static', filename=record.thumbnail_path.replace('static/', '')) }}" alt="Thumbnail">
            {% if record.bbox_info %}
            <canvas data-bbox='{{ record.bbox_info }}' data-person="{{ record.person_name }}"></canvas>
            {% endif %}
            <div class="zoom-indicator">üîç</div>
            {% endif %}
        </div>
        <div class="history-info">
            <p><strong>T√™n:</strong> {{ record.person_name }}</p>
            {% if record.nickname %}
            <p><strong>Nickname:</strong> {{ record.nickname }}</p>
            {% endif %}
            <p><strong>Ch√≠nh x√°c:</strong> {{ (record.score * 100)|round|int }}%</p>
            <p><strong>Th·ªùi gian:</strong> <span class="timestamp" data-timestamp="{{ record.timestamp }}">{{ record.timestamp }}</span></p>
        </div>
        <div class="history-actions">
            {% if record.person_name|lower == 'unknown' or record.person_id is none %}
            <button onclick="showAddPersonModal({{ record.id }})" class="btn btn-sm btn-primary" title="Th√™m v√†o h·ªá th·ªëng">‚ûï Th√™m</button>
            <button onclick="deleteHistory({{ record.id }})" class="btn btn-sm btn-secondary" title="X√≥a kh·ªèi l·ªãch s·ª≠">X√≥a</button>
            {% elif record.trained_image_id %}
            <button onclick="undoRecognition({{ record.id }})" class="btn btn-sm btn-danger" title="Ho√†n t√°c v√† x√≥a ·∫£nh ƒë√£ t·ª± ƒë·ªông train">Undo</button>
            {% else %}
            <button onclick="deleteHistory({{ record.id }})" class="btn btn-sm btn-secondary" title="X√≥a kh·ªèi l·ªãch s·ª≠">X√≥a</button>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

{% if not history %}
<p class="no-data">Ch∆∞a c√≥ l·ªãch s·ª≠ nh·∫≠n di·ªán</p>
{% endif %}

<!-- Add Person Modal -->
<div id="addPersonModal" class="modal d-none">
    <div class="modal-content">
        <span class="close" onclick="closeAddPersonModal()">&times;</span>
        <h2>Th√™m Ng∆∞·ªùi V√†o H·ªá Th·ªëng</h2>
        
        <div class="modal-button-grid">
            <button onclick="showNewPersonForm()" class="btn btn-primary">
                üë§ T·∫°o Ng∆∞·ªùi M·ªõi
            </button>
            <button onclick="showExistingPersonForm()" class="btn btn-secondary">
                ‚ûï Th√™m V√†o Ng∆∞·ªùi C≈©
            </button>
        </div>
        
        <!-- New Person Form -->
        <div id="newPersonForm" class="d-none">
            <h3>T·∫°o Ng∆∞·ªùi M·ªõi</h3>
            <div class="form-group">
                <label for="newPersonNickname">Nickname (*) - T√™n hi·ªÉn th·ªã:</label>
                <input type="text" id="newPersonNickname" placeholder="VD: Vi·ªát Anh" required>
            </div>
            <div class="form-group">
                <label for="newPersonName">T√™n (*) - T·ª± ƒë·ªông t·∫°o (c√≥ th·ªÉ ch·ªânh s·ª≠a):</label>
                <input type="text" id="newPersonName" placeholder="S·∫Ω t·ª± ƒë·ªông ƒëi·ªÅn..." required>
                <small id="newPersonNamePreview" style="color: #667eea; font-weight: 600; display: block; margin-top: 0.25rem;">Nh·∫≠p Nickname ƒë·ªÉ t·ª± ƒë·ªông t·∫°o t√™n</small>
            </div>
            <button onclick="addToNewPerson()" class="btn btn-primary">T·∫°o & Th√™m ·∫¢nh</button>
        </div>
        
        <!-- Existing Person Form -->
        <div id="existingPersonForm" class="d-none">
            <h3>Th√™m V√†o Ng∆∞·ªùi C≈©</h3>
            <div class="form-group">
                <label for="existingPersonSelect">Ch·ªçn ng∆∞·ªùi:</label>
                <select id="existingPersonSelect">
                    <option value="">-- Ch·ªçn ng∆∞·ªùi --</option>
                    {% for person in persons %}
                    <option value="{{ person.id }}">{{ person.nickname or person.name }} ({{ person.name }})</option>
                    {% endfor %}
                </select>
            </div>
            <button onclick="addToExistingPerson()" class="btn btn-primary">Th√™m ·∫¢nh</button>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/history.js') }}"></script>
{% endblock %}
